
# Lab 13: ArgoCD for GitOps Deployment

## Task 1: Deploy and Configure ArgoCD

### Prerequisites

I have installed `ArgoCD` using the provided commands. Then I have defined `argocd-python-app.yaml` in the `ArgoCD` folder.

```bash
❱❱❱ kubectl apply -f k8s/ArgoCD/argocd-python-app.yaml
application.argoproj.io/python-app created
```

Then I have synced the application and checked number of repicas and status before the changes:

#### Before changes

```bash
❱❱❱ kubectl get po
NAME                                              READY   STATUS    RESTARTS      AGE
python-app-python-time-service-744f8b746f-4szjb   1/1     Running   0             2m11s
vault-0                                           1/1     Running   1 (64m ago)   3d17h
vault-agent-injector-66f45b5fd5-dfmbp             1/1     Running   1 (64m ago)   3d17h
```

```bash
❱❱❱ argocd app get python-app
Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/nai1ka/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/python-time-service
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (74d4114)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                                   STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    python-app-pre-install                 Succeeded           PreSync   pod/python-app-pre-install created
       ServiceAccount  default    python-app-python-time-service         Synced                        serviceaccount/python-app-python-time-service created
       ConfigMap       default    python-app-python-time-service-config  Synced                        configmap/python-app-python-time-service-config created
       Service         default    python-app-python-time-service         Synced     Healthy            service/python-app-python-time-service created
apps   Deployment      default    python-app-python-time-service         Synced     Healthy            deployment.apps/python-app-python-time-service created
       Pod             default    python-app-post-install                Succeeded           PostSync  pod/python-app-post-install created
```

#### After changes

I have changed `replicaCount` from 1 to 4

```bash
❱❱ kubectl get po
NAME                                              READY   STATUS    RESTARTS      AGE
python-app-python-time-service-744f8b746f-4szjb   1/1     Running   0             10m
python-app-python-time-service-744f8b746f-hfg47   1/1     Running   0             5m44s
python-app-python-time-service-744f8b746f-jcv75   1/1     Running   0             5m44s
python-app-python-time-service-744f8b746f-vfvcx   1/1     Running   0             5m44s
vault-0                                           1/1     Running   1 (72m ago)   3d17h
vault-agent-injector-66f45b5fd5-dfmbp             1/1     Running   1 (72m ago)   3d17h
```

```bash
❱❱❱ argocd app get python-app
Name:               argocd/python-app
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          default
URL:                https://argocd.example.com/applications/python-app
Source:
- Repo:             https://github.com/nai1ka/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/python-time-service
  Helm Values:      values.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (a5429b5)
Health Status:      Healthy

GROUP  KIND            NAMESPACE  NAME                                   STATUS     HEALTH   HOOK      MESSAGE
       Pod             default    python-app-pre-install                 Succeeded           PreSync   pod/python-app-pre-install created
       ServiceAccount  default    python-app-python-time-service         Synced                        serviceaccount/python-app-python-time-service unchanged
       ConfigMap       default    python-app-python-time-service-config  Synced                        configmap/python-app-python-time-service-config unchanged
       Service         default    python-app-python-time-service         Synced     Healthy            service/python-app-python-time-service unchanged
apps   Deployment      default    python-app-python-time-service         Synced     Healthy            deployment.apps/python-app-python-time-service configured
       Pod             default    python-app-post-install                Succeeded           PostSync  pod/python-app-post-install created
```

As we can see, afther I pushed a commit (note that I am using commit --amend to maintain clean commit history, so there will be only one commit visible in the pull request) the number of replicatas became 4 and `Sync Status` changed to `Sync Status:        Synced to lab13 (a5429b5)` from Sync Status:        Synced to lab13 (74d4114). The hash of commit is different

## Task 2: Multi-Environment Deployment & Auto-Sync

I have added `argocd-python-dev.yaml` and `argocd-python-prod.yaml` to `ArgoCD` folder and `values-dev.yaml` with `values-prod.yaml` to th service folder.
For the development environment, I have set `replicaCount` to 2 and for the production environment, I have set `replicaCount` to 6.

### Test 1

```bash
❱❱❱ kubectl get pods -n prod                                                      
NAME                                                   READY   STATUS              RESTARTS        AGE
python-app-prod-post-install                           0/1     ContainerCreating   0               1s
python-app-prod-pre-install                            0/1     Completed           0               5m26s
python-app-prod-python-time-service-574f976897-25j5l   1/1     Running             0               5m13s
python-app-prod-python-time-service-574f976897-78kvb   1/1     Running             0               5m13s
python-app-prod-python-time-service-574f976897-7wns5   1/1     Running             0               5m12s
python-app-prod-python-time-service-574f976897-9b5d4   1/1     Running             0               5m12s
python-app-prod-python-time-service-574f976897-wfdw7   1/1     Running             0               5m12s
python-app-prod-python-time-service-574f976897-wpzkz   1/1     Running             0               5m13s
```

```bash
❱❱❱  kubectl patch deployment python-app-prod-python-time-service -n prod --patch '{"spec":{"replicas": 3}}'
deployment.apps/python-app-prod-python-time-service patched

❱❱❱ argocd app get python-app-prod
Name:               argocd/python-app-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/python-app-prod
Source:
- Repo:             https://github.com/nai1ka/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/python-time-service
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (f01a676)
Health Status:      Progressing

GROUP  KIND            NAMESPACE  NAME                                        STATUS     HEALTH       HOOK     MESSAGE
       Pod             prod       python-app-prod-pre-install                 Succeeded               PreSync  pod/python-app-prod-pre-install created
       ServiceAccount  prod       python-app-prod-python-time-service         Synced                           serviceaccount/python-app-prod-python-time-service unchanged
       ConfigMap       prod       python-app-prod-python-time-service-config  Synced                           configmap/python-app-prod-python-time-service-config unchanged
       Service         prod       python-app-prod-python-time-service         Synced     Healthy               service/python-app-prod-python-time-service unchanged
apps   Deployment      prod       python-app-prod-python-time-service         Synced     Progressing           deployment.apps/python-app-prod-python-time-service configured
```

```bash
❱❱❱ kubectl get pods -n prod       
NAME                                                   READY   STATUS    RESTARTS        AGE
python-app-prod-python-time-service-574f976897-78kvb   1/1     Running   0               11m
python-app-prod-python-time-service-574f976897-bxcds   1/1     Running   0               101s
python-app-prod-python-time-service-574f976897-g6t4r   1/1     Running   0               101s
python-app-prod-python-time-service-574f976897-gl2zm   1/1     Running   0               101s
python-app-prod-python-time-service-574f976897-wfdw7   1/1     Running   0               11m
python-app-prod-python-time-service-574f976897-wpzkz   1/1     Running   0               11m
```

Three pods were recreated automatically

## Test 2

```bash
kubectl delete pod -n prod python-app-prod-python-time-service-574f976897-wfdw7
pod "python-app-prod-python-time-service-574f976897-wfdw7" deleted


❱❱❱ kubectl get po -n prod
NAME                                                   READY   STATUS    RESTARTS       AGE
python-app-prod-python-time-service-574f976897-78kvb   1/1     Running   0              14m
python-app-prod-python-time-service-574f976897-bxcds   1/1     Running   0              4m37s
python-app-prod-python-time-service-574f976897-g6t4r   1/1     Running   0              4m37s
python-app-prod-python-time-service-574f976897-gl2zm   1/1     Running   0              4m37s
python-app-prod-python-time-service-574f976897-qhg7b   1/1     Running   0              11s
python-app-prod-python-time-service-574f976897-wpzkz   1/1     Running   0              14m

❱❱❱  argocd app diff python-app-prod
```

The pod were recreated automatically and the diff gived empty output and exited with 0 code

## Bonus task

I have created `argocd-kotlin-prod.yaml`, `argocd-kotlin-dev.yaml` and `argocd-kotlin-app.yaml`. I have also created corresponding values files

```bash
❱❱❱ kubectl apply -f k8s/ArgoCD/argocd-kotlin-prod.yaml
application.argoproj.io/kotlin-app-prod created

❱❱❱ argocd app get kotlin-app-prod                     
Name:               argocd/kotlin-app-prod
Project:            default
Server:             https://kubernetes.default.svc
Namespace:          prod
URL:                https://argocd.example.com/applications/kotlin-app-prod
Source:
- Repo:             https://github.com/nai1ka/S25-core-course-labs.git
  Target:           lab13
  Path:             k8s/kotlin-time-service
  Helm Values:      values-prod.yaml
SyncWindow:         Sync Allowed
Sync Policy:        Automated
Sync Status:        Synced to lab13 (665ebc2)
Health Status:      Progressing

GROUP  KIND            NAMESPACE  NAME                                        STATUS  HEALTH       HOOK  MESSAGE
       ServiceAccount  prod       kotlin-app-prod-kotlin-time-service         Synced                     serviceaccount/kotlin-app-prod-kotlin-time-service created
       ConfigMap       prod       kotlin-app-prod-kotlin-time-service-config  Synced                     configmap/kotlin-app-prod-kotlin-time-service-config created
       Service         prod       kotlin-app-prod-kotlin-time-service         Synced  Healthy            service/kotlin-app-prod-kotlin-time-service created
apps   Deployment      prod       kotlin-app-prod-kotlin-time-service         Synced  Progressing        deployment.apps/kotlin-app-prod-kotlin-time-service created

❱❱❱ kubectl get po -n prod
NAME                                                   READY   STATUS              RESTARTS       AGE
kotlin-app-prod-kotlin-time-service-85c5d9b59c-95jqf   1/1     Running             0              104s
kotlin-app-prod-kotlin-time-service-85c5d9b59c-gl9f9   1/1     Running             0              104s
kotlin-app-prod-kotlin-time-service-85c5d9b59c-htllj   1/1     Running             0              104s
kotlin-app-prod-kotlin-time-service-85c5d9b59c-mwzdx   1/1     Running             0              104s
kotlin-app-prod-kotlin-time-service-85c5d9b59c-sqmvc   1/1     Running             0              104s
kotlin-app-prod-kotlin-time-service-85c5d9b59c-zw4t9   1/1     Running             0              104s
python-app-prod-python-time-service-574f976897-78kvb   1/1     Running             0              24m
python-app-prod-python-time-service-574f976897-bxcds   1/1     Running             0              14m
python-app-prod-python-time-service-574f976897-g6t4r   1/1     Running             0              14m
python-app-prod-python-time-service-574f976897-gl2zm   1/1     Running             0              14m
python-app-prod-python-time-service-574f976897-qhg7b   1/1     Running             0              10m
python-app-prod-python-time-service-574f976897-wpzkz   1/1     Running             0              20m
```

As a result, there are 6 `kotlin-app-prod` pods in the `prod` namespace. The sync is successfull
