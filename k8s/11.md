# Lab 11: Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

To create a secret using `kubectl`, I run:

```bash
 ❱❱❱ kubectl create secret generic devops-pass --from-literal=password=MyDevopsSuperSecretPassword228_1337                   
secret/devop-pass created
```

Let's decode and verify it:

```bash
❱❱❱ kubectl get secrets
NAME          TYPE     DATA   AGE
devops-pass   Opaque   1      5s
```

```bash
❱❱❱ kubectl describe secret devops-pass
Name:         devops-pass
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  35 bytes
```

```bash
❱❱❱ kubectl get secret devops-pass -o jsonpath='{.data.password}' | base64 --decode
MyDevopsSuperSecretPassword228_1337
```

As we can see, the secret is successfully created and decoded.

### Managing secrets with Helm

I have follwoed the instructions fro mthe video and created my own GPG key, so I can encrypt the secrets and store them in the repository.

```bash
❱❱❱ brew install gnu-getopt
❱❱❱ gpg --gen-key
❱❱❱ gpg --list-keys
gpg: checking the trustdb
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
gpg: next trustdb check due at 2028-03-02
[keyboxd]
---------
pub   ed25519 2025-03-03 [SC] [expires: 2028-03-02]
      6AFBB81DA2690745BAC4BA1038457149C6186C09
uid           [ultimate] Nail <n.minnemullin@innopolis.university>
sub   cv25519 

❱❱❱ sops -p 6AFBB81DA2690745BAC4BA1038457149C6186C09 secrets.yml
```

In the last command, I entered my password.

Now we can decode and verify it:

```bash
❱❱❱ helm secrets view secrets.yml
password: DevopsPassword228_1337
```

And add this to the `deployment.yaml` file:

```yaml
          env:
          - name: MY_PASS
            valueFrom:
              secretKeyRef:
                name: my-devops-password
                key: password
```

Now, I can install the application using Helm:

```bash
❱❱❱ helm secrets install python-time-service ./python-time-service -n default -f ./secrets.yml
NAME: python-time-service
LAST DEPLOYED: Mon Mar  3 21:48:25 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=python-time-service,app.kubernetes.io/instance=python-time-service" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT


❱❱❱ helm ls
NAME                    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                         APP VERSION
python-time-service     default         1               2025-03-03 21:48:25.613522 +0300 MSK    deployed        python-time-service-0.1.0     1.16.0     


❱❱❱ kubectl get secrets my-devops-password  -o yaml
apiVersion: v1
data:
  password: RGV2b3BzUGFzc3dvcmQyMjhfMTMzNw==
kind: Secret
metadata:
  annotations:
    meta.helm.sh/release-name: python-time-service
    meta.helm.sh/release-namespace: default
  creationTimestamp: "2025-03-03T18:48:38Z"
  labels:
    app.kubernetes.io/managed-by: Helm
  name: my-devops-password
  namespace: default
  resourceVersion: "64003"
  uid: 6f0a9733-2abe-4c43-a1de-d5921a12c5e1
type: Opaque
```

### Verification

```bash
❱❱❱ echo RGV2b3BzUGFzc3dvcmQyMjhfMTMzNw== | base64 -D
DevopsPassword228_1337

❱❱❱ kubectl get po
NAME                                   READY   STATUS    RESTARTS   AGE
python-time-service-568b7d4fbd-g2fjc   1/1     Running   0          7m43s

❱❱❱ kubectl exec python-time-service-568b7d4fbd-g2fjc  -- printenv | grep MY_PASS
MY_PASS=DevopsPassword228_1337
```

## Task 2: Vault Secret Management System

To install the Vault, I have used the following commands:

```bash
❱❱❱ helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories

❱❱❱ helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository

❱❱❱ helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Tue Mar  4 21:36:48 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

❱❱❱ kubectl get pods                                
NAME                                    READY   STATUS    RESTARTS   AGE
python-time-service-568b7d4fbd-g2fjc    1/1     Running   0          23h
vault-0                                 1/1     Running   0          96s
vault-agent-injector-66f45b5fd5-4m6fl   1/1     Running   0          96s
```

To set a secret in the Vault, I have used:

```bash
❱❱❱ kubectl exec -it vault-0 -- /bin/sh
❱❱❱ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/

❱❱❱ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-04T18:41:40.064377175Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

❱❱❱ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-04T18:41:40.064377175Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

Now, I can enable the Kubernetes auth method and create a policy and a service account with a name `python-time-service`:

```bash
❱❱❱ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/


❱❱❱  vault write auth/kubernetes/config kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config

❱❱❱ vault policy write python-time-service - <<EOF
path "internal/data/database/config" {
  capabilities = ["read"]
}
EOF

vault write auth/kubernetes/role/python-time-service bound_service_account_names=python-time-service bound_service_account_namespaces=default policies=python-time-service ttl=24h
Success! Data written to: auth/kubernetes/role/python-time-service
```

Let's verify the service account:

```bash
❱❱❱ kubectl get serviceaccounts
NAME                   SECRETS   AGE
default                0         8d
python-time-service    0         4m6s
vault                  0         16m
vault-agent-injector   0         16m
```

Also, I have added the annotations inside the `values.yaml` file to inject the Vault agent:

```yaml
podAnnotations:
  vault.hashicorp.com/agent-inject: 'true'
  vault.hashicorp.com/role: 'python-time-service'
  vault.hashicorp.com/agent-inject-secret-database-config: 'internal/data/database/config'
  vault.hashicorp.com/agent-inject-template-database-config: |
    {{- with secret "internal/data/database/config" -}}
    export DB_USERNAME="{{ .data.data.username }}"
    export DB_PASSWORD="{{ .data.data.password }}"
    {{- end -}}
```

P.S. We are using Helm, so it is more convinient tu tuse `values.yaml` instead of patching the deployment manually.

I have also changed the `serviceAccount` name in `values.yaml` to `python-time-service`

```bash
serviceAccount:
  create: true
  automount: true
  name: "python-time-service"
  ```

After the chart upgrade, we can see the following:

```bash
❱❱❱ kubectl get po
NAME                                    READY   STATUS    RESTARTS   AGE
python-time-service-799669cc94-77qxd    2/2     Running   0          7s
vault-0                                 1/1     Running   0          16m
vault-agent-injector-66f45b5fd5-dfmbp   1/1     Running   0          16m
```

### Verify

```bash
❱❱❱ kubectl exec -it python-time-service-799669cc94-77qxd -- bash

cat /vault/secrets/database-config
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-03-05T19:08:51.473242337Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
 
df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay          59G   15G   41G  27% /
tmpfs            64M     0   64M   0% /dev
shm              64M     0   64M   0% /dev/shm
tmpfs           7.7G  4.0K  7.7G   1% /vault/secrets
/dev/vda1        59G   15G   41G  27% /etc/hosts
tmpfs           7.7G   12K  7.7G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           3.9G     0  3.9G   0% /proc/scsi
tmpfs           3.9G     0  3.9G   0% /sys/firmware
```

#### Template

Template was already applied in the previous steps (inside the `values.yaml` file)

```yaml
vault.hashicorp.com/agent-inject-template-database-config: |
    {{- with secret "internal/data/database/config" -}}
    export DB_USERNAME="{{ .data.data.username }}"
    export DB_PASSWORD="{{ .data.data.password }}"
    {{- end -}}
```

## Bonus Task: Resource Management and Environment Variables

I have added the following to the `values.yaml` files of both applications:

```yaml
resources:
  limits:
    cpu: 500m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi
```

```bash
helm upgrade python-time-service ./python-time-service
helm upgrade kotlin-time-service ./kotlin-time-service
```

```bash
❱❱❱ kubectl get pod
NAME                                    READY   STATUS    RESTARTS   AGE
python-time-service-794474f956-jxg77    2/2     Running   0          27s
vault-0                                 1/1     Running   0          79m
vault-agent-injector-66f45b5fd5-dfmbp   1/1     Running   0          79m

❱❱❱ kubectl get pod python-time-service-794474f956-jxg77 -o jsonpath='{.spec.containers[0].resources}'
{"limits":{"cpu":"500m","memory":"256Mi"},"requests":{"cpu":"100m","memory":"128Mi"}}
```

As we can see, they are successfully applied.

### Environment Variables

Firstly, I have added the follwoing to `_helpers.tpl`:

```yaml
{{/*
Common environment variables
*/}}
{{- define "python-time-service.environmentVars" -}}
- name: APP_AUTHOR
  value: {{ .Values.environment.author | quote }}
- name: APP_DEBUG
  value: {{ .Values.environment.debug | quote }}
- name: APP_COURSE
  value: {{ .Values.environment.course | quote }}
{{- end -}}
```

The values are added to the `values.yaml` file:

```yaml
environment:
  debug: false
  author: nai1ka
  course: devops
  ```

And also, I needed to update `deployment.yaml` to include the following:

```yaml
 env: {{- include "python-time-service.environmentVars" . | nindent 12 }}
```

Now, after the upgrade, we can see the environment variables:

```bash
helm upgrade python-time-service ./python-time-service

❱❱❱ kubectl exec python-time-service-68bb85f7cb-hlkcx -- printenv | grep -E 'APP_AUTHOR|APP_DEBUG|APP_COURSE'
Defaulted container "python-time-service" out of: python-time-service, vault-agent, vault-agent-init (init)
APP_AUTHOR=nai1ka
APP_DEBUG=false
APP_COURSE=devops
```

They are successfully applied 🎉
